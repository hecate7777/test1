<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>mp4 화일을 30초로 컷하고 마지막 3초는 페이드아웃하여 m4r로 다운로드하는 테스트</title>
</head>
<body>
  <audio id="myAudio" src="트리플에스-beam.mp4"></audio>
  <button onclick="cutAndSave(30, 3)"><h2>mp4 화일을 변형<br>(30초 컷, 3초 페이드아웃)</h2></button>
  <br><br><br>
  <button onclick="download()"><h2>mp4->m4r 다운로드</h2></button>
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js">
  </script>
  
  <script>
    function cutAndSave(cut_time, fadeout_time) {
      const audio = document.getElementById('myAudio');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const startTime = audio.currentTime;
      const endTime = startTime + cut_time;

      audio.currentTime = startTime;
      audio.play();

      audio.addEventListener('timeupdate', function () {
        if (audio.currentTime >= endTime) {
          audio.pause();
          canvas.width = audio.width;
          canvas.height = audio.height;
          ctx.drawImage(audio, 0, 0, audio.width, audio.height);

          const fadeOutStart = audio.duration - fadeout_time;
          const fadeOutEnd = audio.duration;
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

          for (let i = 0; i < imageData.data.length; i += 4) {
            const alpha = (audio.currentTime > fadeOutStart)
              ? 1 - ((audio.currentTime - fadeOutStart) / (fadeOutEnd - fadeOutStart))
              : 1;
            imageData.data[i + 3] = Math.floor(alpha * 255);
          }

          ctx.putImageData(imageData, 0, 0);

          const newAudio = new Audio();
          const newBlob = canvasToBlob(canvas);
          const newUrl = URL.createObjectURL(newBlob);

alert(newUrl)
        
          newAudio.src = newUrl;
          newAudio.controls = true;
          document.body.appendChild(newAudio);
        }
      });

      function canvasToBlob(canvas) {
        return new Promise((resolve, reject) => {
          canvas.toBlob(blob => {
            if (blob) {
              resolve(blob);
            } else {
              reject();
            }
          }, 'audio/mp4', 1);
        });
      }
    }
    
    function download() {
      axios({
        url: '트리플에스-beam-cut.mp4',
        method: 'GET',
        responseType: 'blob'
      })
      .then((response) => {
        const url = window.URL
        .createObjectURL(new Blob([response.data]));
        const link = document.createElement('a');
        link.href = url;
        link.setAttribute('download', 'tripleS.m4r');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      })
    }
  </script>
</body>
</html>


